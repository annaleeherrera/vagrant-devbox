---
  -
    hosts: all
    sudo: True

    vars:
      ruby_version: "2.2"
      postgresql_version: "9.4"

    tasks:
      - name: Update apt-cache if it is staler than 60 minutes
        apt: update_cache=yes cache_valid_time=3600

      - name: Update stale packages
        apt: upgrade=yes

      - name: Install base packages
        apt: pkg={{item}} state=installed
        with_items:
          - ntp
          - build-essential
          - git-core
          - vim
          - vim-nox
          - direnv
          - tmux
          - tmate
          - lua5.2
          # - elixir
          - redis-server
          - redis-tools
          - memcached
          - phantomjs
          - zip
          - unzip
          - htop
          - openvpn

      - name: Make Vim the system editor
        alternatives: name=editor path=/usr/bin/vim link=/usr/bin/editor

      - name: Add Nodesource repository key
        apt_key: url=https://deb.nodesource.com/gpgkey/nodesource.gpg.key state=present

      - name: Add Nodesource apt source
        apt_repository: repo="deb https://deb.nodesource.com/node_4.x {{ansible_lsb.codename}} main" state="present" update_cache=yes

      - name: Install Node
        apt: pkg={{item}} state=latest
        with_items:
          - nodejs
          - autoconf
          - libtool

      - name: Add Postgres repository
        apt_repository: repo='deb http://apt.postgresql.org/pub/repos/apt/ {{ansible_lsb.codename}}-pgdg main' state=present

      - name: Add Postgres repository key
        apt_key: url=http://apt.postgresql.org/pub/repos/apt/ACCC4CF8.asc state=present

      - name: Update apt-cache
        apt: update_cache=yes

      - name: Install Postgresql client
        apt: pkg=postgresql-client-{{postgresql_version}} state=installed

      - name: Install Postgresql server
        apt: pkg={{item}} state=installed
        with_items:
          - python-psycopg2
          - postgresql-{{postgresql_version}}
          - postgresql-contrib-{{postgresql_version}}
          - libpq-dev
          - postgis

      - name: Add Vagrant Postgres user
        postgresql_user: name=vagrant role_attr_flags=SUPERUSER state=present

      - name: Install Ruby
        apt: pkg={{item}} state=installed
        with_items:
          - ruby{{ruby_version}}
          - ruby{{ruby_version}}-dev

      - name: Copy gemrc
        copy: src=./files/gemrc dest=/etc/gemrc backup=yes owner=root group=root mode=0644

      - name: Install alternatives
        command: update-alternatives --install /usr/bin/{{item}} {{item}} /dev/null 50 creates=/etc/alternatives/{{item}}
        with_items:
          - ruby
          - irb
          - rake
          - gem
          - rdoc
          - erb
          - ri

      - name: Update alternatives
        alternatives: name={{item}} path=/usr/bin/{{item}}{{ruby_version}}
        with_items:
          - ruby
          - irb
          - rake
          - gem
          - rdoc
          - erb
          - ri

      - name: Copy bash profile
        copy: src=./files/bash_profile dest=/home/vagrant/.bash_profile backup=yes mode=0644 owner=vagrant group=vagrant

      - name: Remove annoying MOTD messages
        file: path=/etc/update-motd.d/{{item}} state=absent
        with_items:
          - 98-cloudguest
          - 51-cloudguest
          - 10-help-text
